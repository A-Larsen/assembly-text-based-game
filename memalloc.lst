     1                                  global memalloc
     2                                  
     3                                  section .text
     4                                  
     5                                  memalloc:
     6                                  section .data
     7 00000000 00                          .first_call db 0
     8                                  
     9                                  section .bss
    10 00000000 ????????????????            .size resq 1
    11 00000008 ????????????????            .data resq 1
    12 00000010 ????????????????            .alloc_address resq 1
    13                                  
    14                                  section .text
    15 00000000 55                          push rbp
    16 00000001 4889E5                      mov rbp, rsp
    17                                  
    18 00000004 53                          push rbx
    19 00000005 51                          push rcx
    20                                  
    21 00000006 48893C25[08000000]          mov qword [.data], rdi
    22 0000000E 48893425[00000000]          mov qword [.size], rsi
    23                                  
    24 00000016 803C25[00000000]01          cmp byte [.first_call], 1
    25 0000001E 741C                        je .end
    26                                      
    27                                      ; get location of system break
    28 00000020 B80C000000                  mov rax, 12 ; 12 is sys_brk
    29 00000025 BF00000000                  mov rdi, 0
    30 0000002A 0F05                        syscall
    31                                  
    32 0000002C 48890425[10000000]          mov [.alloc_address], rax
    33                                  
    34 00000034 C60425[00000000]01          mov byte [.first_call], 1
    35                                  
    36                                  .end:
    37                                  
    38                                      ; allocate memory by moving system break to a new location
    39 0000003C 488B3C25[10000000]          mov rdi, [.alloc_address]
    40 00000044 48033C25[00000000]          add rdi, [.size]
    41 0000004C B80C000000                  mov rax, 12 ; 12 is sys_brk
    42 00000051 0F05                        syscall
    43                                  
    44 00000053 488B1C25[10000000]          mov rbx, [.alloc_address]
    45 0000005B 488B3C25[08000000]          mov rdi, [.data]
    46 00000063 48893B                      mov qword [rbx], rdi
    47                                  
    48 00000066 488B3C25[00000000]          mov rdi, [.size]
    49 0000006E 488B0425[10000000]          mov rax, [.alloc_address] ; return the starting address of the data
    50 00000076 48013C25[10000000]          add qword [.alloc_address], rdi
    51                                  
    52 0000007E 59                          pop rcx
    53 0000007F 5B                          pop rbx
    54                                  
    55 00000080 C9                          leave
    56 00000081 C3                          ret
